<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∑É‡∑Ñ Free ‡∂Ø‡∑ì‡∂∏‡∂±‡∑è</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f4f9ff;
      color: #222;
    }

    .container {
      max-width: 960px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 14px;
      box-shadow: 0 8px 25px rgba(0,105,192,0.15);
    }

    h1 {
      color: #1565c0;
      margin-bottom: 30px;
      text-align: center;
    }

    .section {
      margin-bottom: 40px;
    }

    .section h2 {
      color: #0d47a1;
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      margin-top: 5px;
      box-sizing: border-box;
    }

    button {
      margin-top: 20px;
      padding: 10px 18px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
    }

    button:hover {
      background: #0d47a1;
    }

    .entry-list {
      margin-top: 20px;
    }

    .entry-list table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }

    .entry-list th, .entry-list td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    .entry-list th {
      background-color: #0288d1;
      color: white;
    }

    .entry-list tr:nth-child(even) td {
      background-color: #f5f5f5;
    }

    @media (max-width: 768px) {
      input, select {
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∑É‡∑Ñ Free ‡∂Ø‡∑ì‡∂∏‡∂±‡∑è</h1>

    <div class="section">
      <h2>1Ô∏è‚É£ ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä (store ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠)</h2>
      <label for="generalDesc">‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</label>
      <input type="text" id="generalDesc" placeholder="‡∂ã‡∂Ø‡∑è: transport, utility...">
      <label for="generalCost">‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω (Rs)</label>
      <input type="number" id="generalCost" min="0" step="0.01" placeholder="0.00">
      <button onclick="addGeneralExpense()">+ ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
    </div>

    <div class="section">
      <h2>2Ô∏è‚É£ Free ‡∂Ø‡∑ì‡∂∏‡∂±‡∑è (store ‡∂ë‡∂ö‡∂ö‡∂ß product)</h2>
      <label for="storeSelect">‡∂ö‡∂©‡∂∫</label>
      <select id="storeSelect"></select>

      <label for="productSelect">‡∂±‡∑í‡∑Ç‡∑ä‡∂¥‡∑è‡∂Ø‡∂±‡∂∫</label>
      <select id="productSelect"></select>

      <label for="freeQty">‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫</label>
      <input type="number" id="freeQty" min="1" placeholder="1">

      <label for="freeCost">‡∂∏‡∑î‡∑Ö‡∑î ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏ (Rs)</label>
      <input type="number" id="freeCost" min="0" step="0.01" placeholder="0.00">

      <button onclick="addFreeItem()">+ ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
    </div>

    <div class="section entry-list">
      <h2>üìÑ ‡∑É‡∑è‡∂∏‡∑è‡∂±‡∑ä‚Äç‡∂∫ ‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏‡∑ä ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä</h2>
      <table id="generalExpenseTable">
        <thead>
          <tr>
            <th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫</th>
            <th>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏ (Rs)</th>
            <th>‡∂Ø‡∑í‡∂±‡∂∫</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2>üéÅ Free ‡∂Ø‡∑ì‡∂∏‡∂±‡∑è ‡∂Ω‡∑ê‡∂∫‡∑í‡∑É‡∑ä‡∂≠‡∑î‡∑Ä</h2>
      <table id="freeExpenseTable">
        <thead>
          <tr>
            <th>‡∂ö‡∂©‡∂∫</th>
            <th>‡∂±‡∑í‡∑Ç‡∑ä‡∂¥‡∑è‡∂Ø‡∂±‡∂∫</th>
            <th>‡∂¥‡∑ä‚Äç‡∂ª‡∂∏‡∑è‡∂´‡∂∫</th>
            <th>‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏ (Rs)</th>
            <th>‡∂Ø‡∑í‡∂±‡∂∫</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const stores = JSON.parse(localStorage.getItem('stores') || '[]');
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');

    const storeSelect = document.getElementById('storeSelect');
    const productSelect = document.getElementById('productSelect');
    const generalTableBody = document.querySelector('#generalExpenseTable tbody');
    const freeTableBody = document.querySelector('#freeExpenseTable tbody');

    function loadDropdowns() {
      storeSelect.innerHTML = '<option value="">-- ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂± --</option>';
      stores.forEach(s => {
        storeSelect.innerHTML += `<option value="${s.id}">${s.storeName || s.name}</option>`;
      });

      productSelect.innerHTML = '<option value="">-- ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂± --</option>';
      products.forEach(p => {
        productSelect.innerHTML += `<option value="${p.id}">${p.productName || p.name}</option>`;
      });
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString('si-LK', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function renderExpenses() {
      generalTableBody.innerHTML = '';
      freeTableBody.innerHTML = '';

      const general = expenses.filter(e => e.type === '‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏');
      const free = expenses.filter(e => e.type === 'Free ‡∂Ø‡∑ì‡∂∏‡∂±‡∑è‡∑Ä');

      if (general.length === 0) {
        generalTableBody.innerHTML = '<tr><td colspan="3">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠</td></tr>';
      } else {
        general.slice().reverse().forEach(e => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${e.desc || '-'}</td>
            <td>Rs. ${parseFloat(e.cost).toFixed(2)}</td>
            <td>${formatDate(e.date)}</td>
          `;
          generalTableBody.appendChild(tr);
        });
      }

      if (free.length === 0) {
        freeTableBody.innerHTML = '<tr><td colspan="5">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠</td></tr>';
      } else {
        free.slice().reverse().forEach(e => {
          const store = stores.find(s => s.id === e.storeId);
          const product = products.find(p => p.id === e.productId);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${store ? (store.storeName || store.name) : '-'}</td>
            <td>${product ? (product.productName || product.name) : '-'}</td>
            <td>${e.qty}</td>
            <td>Rs. ${parseFloat(e.cost).toFixed(2)}</td>
            <td>${formatDate(e.date)}</td>
          `;
          freeTableBody.appendChild(tr);
        });
      }
    }

    function addGeneralExpense() {
      const desc = document.getElementById('generalDesc').value.trim();
      const cost = parseFloat(document.getElementById('generalCost').value);

      if (!desc || isNaN(cost) || cost <= 0) {
        return alert('‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª‡∂∫‡∂ö‡∑ä ‡∑É‡∑Ñ ‡∂∏‡∑î‡∂Ø‡∂Ω‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±');
      }

      const date = new Date().toISOString();

      expenses.push({
        type: '‡∑Ä‡∑í‡∂∫‡∂Ø‡∂∏',
        desc,
        cost,
        date
      });

      localStorage.setItem('expenses', JSON.stringify(expenses));

      // clear fields
      document.getElementById('generalDesc').value = '';
      document.getElementById('generalCost').value = '';
      renderExpenses();
    }

    function addFreeItem() {
      const storeId = storeSelect.value;
      const productId = productSelect.value;
      const qty = parseInt(document.getElementById('freeQty').value);
      const cost = parseFloat(document.getElementById('freeCost').value);

      if (!storeId || !productId || isNaN(qty) || qty <= 0 || isNaN(cost) || cost <= 0) {
        return alert('‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∑É‡∑í‡∂∫‡∑Ö‡∑î‡∂∏ ‡∂≠‡∑ú‡∂ª‡∂≠‡∑î‡∂ª‡∑î ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±');
      }

      const date = new Date().toISOString();

      expenses.push({
        type: 'Free ‡∂Ø‡∑ì‡∂∏‡∂±‡∑è‡∑Ä',
        storeId,
        productId,
        qty,
        cost,
        date
      });

      // üßÆ Profit ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂Ö‡∂©‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
      const month = date.slice(0,7); // "YYYY-MM"
      let profits = JSON.parse(localStorage.getItem('monthlyProfits') || '{}');
      if (!profits[month]) profits[month] = 0;
      profits[month] -= cost;
      if (profits[month] < 0) profits[month] = 0;
      localStorage.setItem('monthlyProfits', JSON.stringify(profits));

      localStorage.setItem('expenses', JSON.stringify(expenses));

      // clear fields
      storeSelect.value = '';
      productSelect.value = '';
      document.getElementById('freeQty').value = '';
      document.getElementById('freeCost').value = '';

      renderExpenses();
    }

    loadDropdowns();
    renderExpenses();
  </script>
</body>
</html>
