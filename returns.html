<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Return History</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;background:#f4f9ff;margin:0;padding:20px}
    h1{text-align:center;color:#1565c0}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{padding:10px;border:1px solid #ddd;text-align:center}
    th{background:#0288d1;color:white}
    tr:hover{background:#e3f2fd}
    #monthlyReturnSummary{margin-top:20px;font-weight:600;color:#01579b}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center}
    .modal-content{background:#fff;padding:20px;border-radius:14px;width:95%;max-width:600px;overflow-x:auto}
    .closeBtn{float:right;background:#e53935;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer}
    @media(max-width:600px){.modal-content{width:95%}}
  </style>
</head>
<body>

<h1>ආපසු ගත් ඉතිහාසය</h1>

<label>අවුරුද්ද:</label>
<input type="number" id="yearFilter" placeholder="2025">
<label>මාසය:</label>
<input type="number" id="monthFilter" min="1" max="12" placeholder="8">
<button onclick="applyFilter()">Filter</button>

<table>
  <thead>
    <tr>
      <th>කඩය</th>
      <th>දිනය</th>
      <th>මුළු ආපසු මුදල</th>
      <th>විස්තර</th>
    </tr>
  </thead>
  <tbody id="returnsTableBody"></tbody>
</table>

<p id="monthlyReturnSummary"></p>

<!-- Modal -->
<div id="returnModal" class="modal">
  <div class="modal-content">
    <button class="closeBtn" onclick="document.getElementById('returnModal').style.display='none'">X</button>
    <h3>Return Details</h3>
    <table>
      <tbody id="returnDetailBody"></tbody>
    </table>
  </div>
</div>

<script>
const bills = JSON.parse(localStorage.getItem('bills') || '[]');
const stores = JSON.parse(localStorage.getItem('stores') || '[]');

function formatDate(d){
  return new Date(d).toLocaleDateString('si-LK',{year:'numeric',month:'2-digit',day:'2-digit'});
}

// filter returns
function filterReturns(year='',month=''){
  return bills.filter(b=>{
    const date=new Date(b.date);
    return (!year || date.getFullYear()==year) &&
           (!month || date.getMonth()+1==month) &&
           (b.returns && b.returns.length>0);
  });
}

// render main table in reverse order (last entry on top)
function renderReturnList(year='',month=''){
  const filtered=filterReturns(year,month).slice().reverse();
  const tbody=document.getElementById('returnsTableBody');
  tbody.innerHTML='';
  if(filtered.length===0){
    tbody.innerHTML='<tr><td colspan="4">දත්ත නොමැත</td></tr>';
    document.getElementById('monthlyReturnSummary').textContent='';
    return;
  }

  let monthlySum=0;

  filtered.forEach(bill=>{
    const store=stores.find(s=>s.id===bill.storeId);
    const storeName=store?store.storeName||store.name:'නොදන්නා';
    const totalReturn=bill.returns.reduce((a,r)=>a+(r.returnPrice||0),0);
    monthlySum+=totalReturn;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${storeName}</td>
      <td>${formatDate(bill.date)}</td>
      <td>Rs. ${totalReturn.toFixed(2)}</td>
      <td><button onclick="viewDetails('${bill.id}')">විස්තර</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('monthlyReturnSummary').textContent =
    `තෝරාගත් මාසයේ ආපසු මුදල: Rs. ${monthlySum.toFixed(2)}`;
}

// horizontal flip modal
function viewDetails(billId){
  const bill=bills.find(b=>b.id===billId);
  if(!bill)return;
  const body=document.getElementById('returnDetailBody');
  body.innerHTML='';

  const rowItem = document.createElement('tr');
  const rowPrice = document.createElement('tr');
  const rowPercent = document.createElement('tr');

  rowItem.innerHTML = `<th>අයිතමය</th>`;
  rowPrice.innerHTML = `<th>මුදල</th>`;
  rowPercent.innerHTML = `<th>%</th>`;

  bill.returns.forEach(r=>{
    rowItem.innerHTML += `<td>${r.name}</td>`;
    rowPrice.innerHTML += `<td>Rs. ${(r.returnPrice||0).toFixed(2)}</td>`;
    rowPercent.innerHTML += `<td>${(r.percent*100).toFixed(0)}%</td>`;
  });

  body.appendChild(rowItem);
  body.appendChild(rowPrice);
  body.appendChild(rowPercent);

  document.getElementById('returnModal').style.display='flex';
}

function applyFilter(){
  const y=document.getElementById('yearFilter').value;
  const m=document.getElementById('monthFilter').value;
  renderReturnList(y,m);
}

// initial load
renderReturnList();
</script>

</body>
</html>
