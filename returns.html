<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∂Ü‡∂¥‡∑É‡∑î ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∑ä ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f0f7ff;
      margin: 0; padding: 20px;
      color: #222;
    }

    .container {
      max-width: 720px;
      width: 90vw;
      margin: 20px auto;
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0, 105, 192, 0.2);
      overflow-x:hidden;
      box-sizing: border-box;
    }

    .scroll{
      max-width: 720px;
      width: 90vw;
      overflow-x:scroll;
      box-sizing: border-box;
    }

    h1 {
      color: #1565c0;
      text-align: center;
      margin-bottom: 25px;
    }

    .filters {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    select {
      padding: 10px 15px;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #f9fcff;
      cursor: pointer;
      min-width: 130px;
      transition: 0.3s ease;
    }
    select:focus {
      outline: none;
      border-color: #2196f3;
      box-shadow: 0 0 6px rgba(33,150,243,0.3);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      margin-bottom: 25px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px 10px;
      border: 1px solid #e0e0e0;
      text-align: center;
      white-space: nowrap;
    }

    th {
      background-color: #0288d1;
      color: #fff;
      font-weight: 600;
    }

    tr:nth-child(even) td {
      background-color: #f9f9f9;
    }

    td.store-name {
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: default;
    }
    td.store-name:hover {
      white-space: normal;
      background-color: #e3f2fd;
    }

    button.viewDetailsBtn {
      background-color: #0288d1;
      border: none;
      color: white;
      padding: 7px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    button.viewDetailsBtn:hover {
      background-color: #01579b;
    }

    /* Modal styles */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      padding-top: 80px; 
      left: 0; top: 0; width: 100%; height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #e3f2fd;
      margin: auto;
      padding: 20px;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 2px 12px rgba(3, 86, 167, 0.3);
      position: relative;
    }

    .modal-header {
      font-size: 1.3rem;
      color: #01579b;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .close-btn {
      position: absolute;
      top: 12px;
      right: 20px;
      font-size: 1.5rem;
      font-weight: bold;
      color: #01579b;
      cursor: pointer;
      border: none;
      background: transparent;
    }

    .modal table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    .modal th, .modal td {
      border: 1px solid #c8d8ff;
      padding: 10px 8px;
      text-align: center;
      white-space: nowrap;
    }
    .modal th {
      background-color: #1976d2;
      color: white;
      font-weight: 600;
    }
    .modal tr:nth-child(even) td {
      background-color: #dbe9ff;
    }

    /* Summary for selected month */
    .summary {
      font-weight: 700;
      font-size: 1.1rem;
      color: #01579b;
      margin-bottom: 10px;
      text-align: center;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
        align-items: center;
      }
      table, th, td {
        font-size: 0.85rem;
      }
      td.store-name {
        max-width: 110px;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>üîÑ ‡∂Ü‡∂¥‡∑É‡∑î ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∑ä ‡∂â‡∂≠‡∑í‡∑Ñ‡∑è‡∑É‡∂∫</h1>

    <div class="filters">
      <select id="yearFilter" title="‡∑Ä‡∑É‡∂ª ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±"></select>
      <select id="monthFilter" title="‡∂∏‡∑è‡∑É‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±"></select>
    </div>

    <div class="scroll">
    <table id="returnsTable">
      <thead>
        <tr>
          <th>‡∂ö‡∂©‡∂∫</th>
          <th>‡∂Ø‡∑í‡∂±‡∂∫</th>
          <th>‡∂Ü‡∂¥‡∑É‡∑î ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑î‡∂±‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω</th>
          <th>‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </div>

  <!-- Modal for return details -->
  <div id="returnModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="closeModalBtn">&times;</button>
      <div class="modal-header">‡∂Ü‡∂¥‡∑É‡∑î ‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª</div>
      <table>
        <thead>
          <tr>
            <th>‡∂Ö‡∂∫‡∑í‡∂≠‡∂∏‡∂∫</th>
            <th>‡∑Ä‡∂ß‡∑í‡∂±‡∑è‡∂ö‡∂∏</th>
          </tr>
        </thead>
        <tbody id="returnDetailBody"></tbody>
      </table></div>
    </div>
    <div class="summary" id="monthlyReturnSummary"></div>
  </div>
  

  <script>
    const returns = JSON.parse(localStorage.getItem('returns') || '[]');
    const stores = JSON.parse(localStorage.getItem('stores') || '[]');

    const yearFilter = document.getElementById('yearFilter');
    const monthFilter = document.getElementById('monthFilter');
    const returnsTableBody = document.querySelector('#returnsTable tbody');
    const monthlyReturnSummary = document.getElementById('monthlyReturnSummary');

    // Modal elements
    const returnModal = document.getElementById('returnModal');
    const returnDetailBody = document.getElementById('returnDetailBody');
    const closeModalBtn = document.getElementById('closeModalBtn');

    // Unique years from return dates
    const uniqueYears = [...new Set(returns.map(r => new Date(r.date).getFullYear()))].sort((a,b) => b - a);

    function populateYearFilter() {
      yearFilter.innerHTML = '<option value="">-- ‡∑Ä‡∑É‡∂ª ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂± --</option>';
      uniqueYears.forEach(y => {
        yearFilter.innerHTML += `<option value="${y}">${y}</option>`;
      });
    }

    function populateMonthFilter(selectedYear) {
      const months = [
        {val: 1, name: '‡∂¢‡∂±‡∑Ä‡∑è‡∂ª‡∑í'},
        {val: 2, name: '‡∂¥‡∑ô‡∂∂‡∂ª‡∑Ä‡∑è‡∂ª‡∑í'},
        {val: 3, name: '‡∂∏‡∑è‡∂ª‡∑ä‡∂≠‡∑î'},
        {val: 4, name: '‡∂Ö‡∂¥‡∑ä‚Äç‡∂ª‡∑ö‡∂Ω‡∑ä'},
        {val: 5, name: '‡∂∏‡∑ê‡∂∫‡∑í'},
        {val: 6, name: '‡∂¢‡∑î‡∂±‡∑í'},
        {val: 7, name: '‡∂¢‡∑î‡∂Ω‡∑í'},
        {val: 8, name: '‡∂Ö‡∂ú‡∑ù‡∑É‡∑ä‡∂≠‡∑î'},
        {val: 9, name: '‡∑É‡∑ê‡∂¥‡∑ä‡∂≠‡∑ê‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä'},
        {val: 10, name: '‡∂î‡∂ö‡∑ä‡∂≠‡∑ù‡∂∂‡∂ª‡∑ä'},
        {val: 11, name: '‡∂±‡∑ú‡∑Ä‡∑ê‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä'},
        {val: 12, name: '‡∂Ø‡∑ô‡∑É‡∑ê‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä'}
      ];
      monthFilter.innerHTML = '<option value="">-- ‡∂∏‡∑è‡∑É‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂± --</option>';

      const filteredMonths = returns.filter(r => {
        const d = new Date(r.date);
        return d.getFullYear() === Number(selectedYear);
      });

      const uniqueMonths = [...new Set(filteredMonths.map(r => new Date(r.date).getMonth() +1 ))];

      months.forEach(m => {
        if(selectedYear === '' || uniqueMonths.includes(m.val)){
          monthFilter.innerHTML += `<option value="${m.val}">${m.name}</option>`;
        }
      });
    }

    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString('si-LK', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function filterReturns(year, month) {
      return returns.filter(r => {
        const d = new Date(r.date);
        if(year && d.getFullYear() !== Number(year)) return false;
        if(month && (d.getMonth() + 1) !== Number(month)) return false;
        return true;
      });
    }

    function renderReturnList(year = '', month = '') {
      const filtered = filterReturns(year, month);

      returnsTableBody.innerHTML = '';
      if(filtered.length === 0) {
        returnsTableBody.innerHTML = `<tr><td colspan="4">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠</td></tr>`;
        monthlyReturnSummary.textContent = '';
        returnModal.style.display = 'none';
        return;
      }

      filtered.forEach(r => {
        const store = stores.find(s => s.id === r.storeId);
        const storeName = store ? (store.storeName || store.name || '‡∂±‡∑ú‡∂Ø‡∂±‡∑ä‡∂±‡∑è') : '‡∂±‡∑ú‡∂Ø‡∂±‡∑ä‡∂±‡∑è';
        const totalReturn = r.items.reduce((acc, i) => acc + (i.returnPrice || 0), 0);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="store-name" title="${storeName}">${storeName}</td>
          <td>${formatDate(r.date)}</td>
          <td>Rs. ${totalReturn.toFixed(2)}</td>
          <td><button class="viewDetailsBtn" data-id="${r.id}">‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±</button></td>
        `;
        returnsTableBody.appendChild(tr);
      });

      const monthlySum = filtered.reduce((acc, r) => {
        return acc + r.items.reduce((a, i) => a + (i.returnPrice || 0), 0);
      }, 0);

      monthlyReturnSummary.textContent = `‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∂≠‡∑ä ‡∂∏‡∑è‡∑É‡∂∫‡∑ö ‡∂Ü‡∂¥‡∑É‡∑î ‡∂Ω‡∂∂‡∑è‡∂Ø‡∑î‡∂±‡∑ä ‡∂∏‡∑î‡∂Ø‡∂Ω: Rs. ${monthlySum.toFixed(2)}`;
    }

    // Open modal with return details
    returnsTableBody.addEventListener('click', e => {
      if(e.target.classList.contains('viewDetailsBtn')) {
        const returnId = e.target.getAttribute('data-id');
        const ret = returns.find(r => r.id === returnId);
        if(!ret) return;

        returnDetailBody.innerHTML = '';

        ret.items.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.name}</td>
            <td>Rs. ${(item.returnPrice || 0).toFixed(2)}</td>
          `;
          returnDetailBody.appendChild(tr);
        });

        returnModal.style.display = 'block';
      }
    });

    // Close modal on close button click
    closeModalBtn.addEventListener('click', () => {
      returnModal.style.display = 'none';
    });

    // Close modal on clicking outside modal content
    window.addEventListener('click', e => {
      if(e.target === returnModal) {
        returnModal.style.display = 'none';
      }
    });

    // Initial
    populateYearFilter();
    populateMonthFilter('');
    renderReturnList();

    yearFilter.addEventListener('change', () => {
      const y = yearFilter.value;
      populateMonthFilter(y);
      renderReturnList(y, '');
    });
    monthFilter.addEventListener('change', () => {
      renderReturnList(yearFilter.value, monthFilter.value);
    });
  </script>
</body>
</html>
