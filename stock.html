<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stock Management</title>
  <style>
    /* Base reset */
    * {
      box-sizing: border-box;
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: #f0f4f8;
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      user-select: none;
      padding-bottom: 40px;
    }
    .container {
      max-width: 960px;
      margin: 25px auto;
      padding: 0 15px;
      flex-grow: 1;
    }
    /* Header */
    .main-header {
      background-color: #1976d2;
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgb(25 118 210 / 0.4);
      user-select: none;
    }
    .main-header h1 {
      font-size: 1.7rem;
      font-weight: 700;
    }
    .logout-btn {
      background-color: #d32f2f;
      border: none;
      padding: 10px 20px;
      font-weight: 700;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .logout-btn:hover {
      background-color: #9a2525;
    }
    /* Form styles */
    h2 {
      margin-bottom: 15px;
      color: #1976d2;
      font-weight: 700;
    }
    form {
      background: white;
      padding: 20px 25px;
      border-radius: 14px;
      box-shadow: 0 6px 15px rgb(0 0 0 / 0.1);
      margin-bottom: 40px;
    }
    .form-row {
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
    }
    label {
      font-weight: 600;
      margin-bottom: 6px;
      color: #333;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"] {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 6px rgb(25 118 210 / 0.4);
    }
    /* Buttons */
    .action-btn {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.1rem;
      box-shadow: 0 5px 15px rgb(25 118 210 / 0.5);
      transition: background-color 0.3s ease, transform 0.25s ease;
      user-select: none;
    }
    .action-btn:hover {
      background-color: #1565c0;
      transform: translateY(-3px);
    }
    .action-btn1 {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1.1rem;
      box-shadow: 0 5px 15px rgb(25 118 210 / 0.5);
      transition: background-color 0.3s ease, transform 0.25s ease;
      user-select: none;
      margin-top: 15px;
      width: 220px;
    }
    .action-btn1:hover {
      background-color: #1565c0;
      transform: translateY(-3px);
    }

    /* ======= Updated product list style ======= */
    .product-list-section {
      margin-top: 30px;
    }
    #searchInput {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      width: 100%;
      font-size: 1rem;
    }
    .product-item {
      background: white;
      border-radius: 14px;
      box-shadow: 0 6px 15px rgb(0 0 0 / 0.1);
      margin-bottom: 18px;
      padding: 16px 20px;
      user-select: none;
      display: flex;
      flex-direction: column;
    }
    /* row-top with label + value vertical stack for each column */
    .product-item .row-top {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    .product-item .row-top > div {
      flex: 1;
      min-width: 120px;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    .product-item .row-top > div.cost {
      flex: 0.7;
    }
    .product-item .row-top > div .label {
      font-weight: 600;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 6px;
      user-select: none;
    }
    .product-item .row-top > div .value {
      font-weight: 700;
      font-size: 1.1rem;
      color: #222;
      user-select: text;
    }

    .product-item .row-bottom {
      margin-top: 12px;
      text-align: right;
    }
    .product-item .row-bottom button {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 12px;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .product-item .row-bottom button.delete {
      background-color: #d32f2f;
    }
    .product-item .row-bottom button:hover {
      filter: brightness(0.85);
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      .product-item .row-top {
        flex-direction: column;
        gap: 8px;
      }
      .product-item .row-top > div {
        min-width: 100%;
      }
      .product-item .row-bottom button {
        padding: 10px 16px;
        font-size: 1rem;
        margin-left: 8px;
      }
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      user-select: none;
    }
    .modal-content {
      background-color: #fff;
      margin: 80px auto;
      padding: 25px 30px;
      border-radius: 14px;
      width: 90%;
      max-width: 480px;
      box-shadow: 0 10px 25px rgb(0 0 0 / 0.3);
      position: relative;
      user-select: text;
    }
    .close-btn {
      color: #888;
      font-size: 28px;
      font-weight: 700;
      position: absolute;
      top: 15px;
      right: 18px;
      cursor: pointer;
      user-select: none;
      transition: color 0.3s ease;
    }
    .close-btn:hover {
      color: #d32f2f;
    }
  </style>
</head>
<body>
  <header class="main-header">
    <h1>Stock Management</h1>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </header>

  <center>
    <button class="action-btn1" onclick="location.href='outOfStock.html'">Out of stock</button>
    <button class="action-btn1" onclick="location.href='lowstock.html'">Low stock</button>
    <button class="action-btn1" onclick="location.href='stocklist.html'">stock list</button>
  </center>

  <main class="container">
    <!-- Add Product Form -->
    <section class="add-product-section">
      <h2>නව නිෂ්පාදනය එක් කරන්න</h2>
      <form id="addProductForm">
        <div class="form-row">
          <label for="productName">නිෂ්පාදන නම</label>
          <input type="text" id="productName" name="productName" required />
        </div>

        <div class="form-row">
          <label for="quantity">ප්‍රමාණය</label>
          <input type="number" id="quantity" name="quantity" min="1" required />
        </div>

        <div class="form-row">
          <label for="costPrice">මිල (පිරිවැය)</label>
          <input type="number" id="costPrice" name="costPrice" min="0" step="0.01" required />
        </div>

        <div class="form-row">
          <label for="expiryDate">කල් ඉකුත්වීමේ දිනය</label>
          <input type="date" id="expiryDate" name="expiryDate" required />
        </div>

        <button type="submit" class="action-btn">නිෂ්පාදනය එක් කරන්න</button>
      </form>
    </section>

    <!-- Product List -->
    <section class="product-list-section">
      <h2>නිෂ්පාදන ලැයිස්තුව</h2>
      <input type="text" id="searchInput" placeholder="නිෂ්පාදන නම අනුව සෙවීම..." />

      <div id="productListContainer">
        <!-- Products rendered here -->
      </div>
    </section>
  </main>

  <!-- Edit Product Modal -->
  <div id="editModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
    <div class="modal-content">
      <span class="close-btn" id="closeEditModal" aria-label="Close modal">&times;</span>
      <h2 id="modalTitle">නිෂ්පාදනය සකස් කරන්න</h2>
      <form id="editProductForm">
        <div class="form-row">
          <label for="editProductName">නිෂ්පාදන නම</label>
          <input type="text" id="editProductName" name="editProductName" required />
        </div>

        <div class="form-row">
          <label for="editQuantity">ප්‍රමාණය</label>
          <input type="number" id="editQuantity" name="editQuantity" min="1" required />
        </div>

        <div class="form-row">
          <label for="editCostPrice">මිල (පිරිවැය)</label>
          <input type="number" id="editCostPrice" name="editCostPrice" min="0" step="0.01" required />
        </div>

        <div class="form-row">
          <label for="editExpiryDate">කල් ඉකුත්වීමේ දිනය</label>
          <input type="date" id="editExpiryDate" name="editExpiryDate" required />
        </div>

        <button type="submit" class="action-btn">සුරකින්න</button>
      </form>
    </div>
  </div>

  <!-- Add Quantity Modal -->
  <div id="addQtyModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="addQtyModalTitle" aria-modal="true">
    <div class="modal-content">
      <span class="close-btn" id="closeAddQtyModal" aria-label="Close modal">&times;</span>
      <h2 id="addQtyModalTitle">ප්‍රමාණය එක් කරන්න</h2>
      <form id="addQtyForm">
        <div class="form-row">
          <label for="addQuantityInput">එකතු කළ යුතු ප්‍රමාණය</label>
          <input type="number" id="addQuantityInput" name="addQuantityInput" min="1" required />
        </div>
        <button type="submit" class="action-btn">එකතු කරන්න</button>
      </form>
    </div>
  </div>

<script>
  const productForm = document.getElementById('addProductForm');
  const productListContainer = document.getElementById('productListContainer');
  const searchInput = document.getElementById('searchInput');
  const editModal = document.getElementById('editModal');
  const closeEditModalBtn = document.getElementById('closeEditModal');
  const editProductForm = document.getElementById('editProductForm');
  const logoutBtn = document.getElementById('logoutBtn');

  let products = [];
  let editIndex = null;
  let addQtyIndex = null; // New for add quantity modal

  function loadProducts() {
    const stored = localStorage.getItem('products');
    if (stored) {
      products = JSON.parse(stored);
    } else {
      products = [
        {
          id: '1',
          productName: 'දෙමළ ගහ',
          quantity: 20,
          costPrice: 150.5,
          expiryDate: '2025-12-31'
        },
        {
          id: '2',
          productName: 'කොළ පාන්',
          quantity: 50,
          costPrice: 85.0,
          expiryDate: '2025-11-15'
        }
      ];
      saveProducts();
    }
    renderProductList();
  }

  function saveProducts() {
    localStorage.setItem('products', JSON.stringify(products));
  }

  function renderProductList() {
    const filterText = searchInput.value.trim().toLowerCase();
    productListContainer.innerHTML = '';

    let filtered = products;
    if (filterText !== '') {
      filtered = products.filter(p => p.productName.toLowerCase().includes(filterText));
    }

    if (filtered.length === 0) {
      productListContainer.innerHTML = `<p style="text-align:center; padding:20px;">කිසිඳු නිෂ්පාදන නොමැත</p>`;
      return;
    }

    filtered.forEach((p, i) => {
      const realIndex = products.findIndex(prod => prod.id === p.id);

      const productDiv = document.createElement('div');
      productDiv.className = 'product-item';

      productDiv.innerHTML = `
        <div class="row-top">
          <div>
            <div class="label">නිෂ්පාදන නම</div>
            <div class="value">${p.productName}</div>
          </div>
          <div>
            <div class="label">ප්‍රමාණය</div>
            <div class="value">${p.quantity}</div>
          </div>
          <div class="cost">
            <div class="label">මිල (පිරිවැය)</div>
            <div class="value">රු.${p.costPrice.toFixed(2)}</div>
          </div>
        </div>
        <div class="row-bottom">
          <button onclick="openEditModal(${realIndex})">සකසන්න</button>
          <button onclick="openAddQtyModal(${realIndex})">quantity</button>
          <button class="delete" onclick="deleteProduct(${realIndex})">මකන්න</button>
        </div>
      `;

      productListContainer.appendChild(productDiv);
    });
  }

  function deleteProduct(i) {
    if (confirm('මෙම නිෂ්පාදනය මකන්නද?')) {
      products.splice(i, 1);
      saveProducts();
      renderProductList();
    }
  }

  function openEditModal(i) {
    editIndex = i;
    const p = products[i];
    editProductForm.editProductName.value = p.productName;
    editProductForm.editQuantity.value = p.quantity;
    editProductForm.editCostPrice.value = p.costPrice;
    editProductForm.editExpiryDate.value = p.expiryDate;

    editModal.style.display = 'block';
    editModal.setAttribute('aria-hidden', 'false');
    editProductForm.editProductName.focus();
  }

  function closeEditModal() {
    editModal.style.display = 'none';
    editModal.setAttribute('aria-hidden', 'true');
    editIndex = null;
  }

  closeEditModalBtn.addEventListener('click', closeEditModal);
  window.addEventListener('click', e => {
    if (e.target === editModal) closeEditModal();
  });

  editProductForm.addEventListener('submit', e => {
    e.preventDefault();
    const expiryDate = editProductForm.editExpiryDate.value;
    if (new Date(expiryDate) < new Date(new Date().toISOString().split('T')[0])) {
      alert('කල් ඉකුත්වීමේ දිනය අද දිනයට හෝ පසුව යුතුය.');
      return;
    }
    products[editIndex] = {
      id: products[editIndex].id || Date.now().toString(),
      productName: editProductForm.editProductName.value.trim(),
      quantity: parseInt(editProductForm.editQuantity.value),
      costPrice: parseFloat(editProductForm.editCostPrice.value),
      expiryDate: expiryDate
    };
    saveProducts();
    renderProductList();
    closeEditModal();
  });

  productForm.addEventListener('submit', e => {
    e.preventDefault();
    const productName = productForm.productName.value.trim();
    const quantity = parseInt(productForm.quantity.value);
    const costPrice = parseFloat(productForm.costPrice.value);
    const expiryDate = productForm.expiryDate.value;

    if (!productName || quantity < 1 || isNaN(costPrice) || !expiryDate) {
      alert('කරුණාකර සියලු ක්ෂේත්‍ර වල නිවැරදි තොරතුරු ඇතුළත් කරන්න.');
      return;
    }
    if (new Date(expiryDate) < new Date(new Date().toISOString().split('T')[0])) {
      alert('කල් ඉකුත්වීමේ දිනය අද දිනයට හෝ පසුව යුතුය.');
      return;
    }
    const newProduct = {
      id: Date.now().toString(),
      productName,
      quantity,
      costPrice,
      expiryDate
    };
    products.push(newProduct);
    saveProducts();
    renderProductList();
    productForm.reset();
  });

  // Logout button handler
  logoutBtn.addEventListener('click', () => {
    if (confirm('Logout වෙන්න අවශ්‍යද?')) {
      localStorage.clear();
      location.href = 'index.html'; // Change as per login page
    }
  });

  // ====== Add Quantity Modal related ======
  const addQtyModal = document.getElementById('addQtyModal');
  const closeAddQtyModalBtn = document.getElementById('closeAddQtyModal');
  const addQtyForm = document.getElementById('addQtyForm');
  const addQuantityInput = document.getElementById('addQuantityInput');

  function openAddQtyModal(i) {
    addQtyIndex = i;
    addQuantityInput.value = '';
    addQtyModal.style.display = 'block';
    addQtyModal.setAttribute('aria-hidden', 'false');
    addQuantityInput.focus();
  }

  function closeAddQtyModal() {
    addQtyModal.style.display = 'none';
    addQtyModal.setAttribute('aria-hidden', 'true');
    addQtyIndex = null;
  }

  closeAddQtyModalBtn.addEventListener('click', closeAddQtyModal);
  window.addEventListener('click', e => {
    if (e.target === addQtyModal) closeAddQtyModal();
  });

  addQtyForm.addEventListener('submit', e => {
    e.preventDefault();
    const val = parseInt(addQuantityInput.value);
    if (isNaN(val) || val <= 0) {
      alert('කරුණාකර වලංගු ප්‍රමාණයක් ඇතුළත් කරන්න.');
      return;
    }
    if (addQtyIndex !== null && products[addQtyIndex]) {
      products[addQtyIndex].quantity = (parseInt(products[addQtyIndex].quantity) || 0) + val;
      saveProducts();
      renderProductList();
      closeAddQtyModal();
    }
  });

  // Search input filter live update
  searchInput.addEventListener('input', renderProductList);

  // Initialize on page load
  loadProducts();
</script>
</body>
</html>
